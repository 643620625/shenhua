<!DOCTYPE html>
<meta charset="utf-8">
<title>抽奖 - 神话抽卡</title>
<style>
  body{background:#fff;font-family:sans-serif;text-align:center;padding:20px}
  button{padding:8px 16px;font-size:16px;margin:6px;cursor:pointer}
  
  /* 仙缘显示 */
  .xianyuan-display {
    font-size: 18px;
    font-weight: bold;
    color: #e65100;
    background: #fff3cd;
    padding: 8px 16px;
    border-radius: 8px;
    display: inline-block;
    margin: 10px 0;
  }
  
  /* 当前抽中卡片样式 */
  .current-card{
    margin: 20px auto;
    width: 160px;
    height: 220px;
    border: 3px solid #000;
    border-radius: 10px;
    font-size: 20px;
    font-weight: bold;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .current-card .hp{
    font-size: 16px;
    margin-top: 15px;
    color: #333;
  }
  .current-card .rank{
    font-size: 14px;
    margin-top: 10px;
    color: #666;
  }
  
  /* 颜色样式 */
  .white{background:#eee;color:#000}
  .green{background:#2e7d32;color:#fff}
  .blue{background:#1565c0;color:#fff}
  .gold{background:#ffd900bd;color:#fff}
  .orange{background:#ef6c00;color:#fff}
  .red{background:#c62828;color:#fff}
</style>

<h2>抽奖</h2>
<script src="common.js"></script>

<!-- 仙缘显示 -->
<div class="xianyuan-display">
  仙缘: <span id="xianyuanDisplay">0</span>
</div>

<button onclick="draw()" id="drawBtn">抽一次 (消耗10仙缘)</button>
<button onclick="location.href='index.html'">返回首页</button>

<div id="currentCard" class="current-card">
  <div>点击"抽一次"</div>
  <div class="rank">开始抽卡</div>
</div>

<script>
// 页面加载时初始化
window.onload = function() {
  // 加载存档
  if (localStorage.getItem("myth_save")) {
    loadSilent();
  }
  // 初始化系统
  BreakthroughSystem.init();
  RealmBattleSystem.init();
  // 更新仙缘显示
  updateXianyuanDisplay();
  // 更新按钮状态
  updateDrawButton();
};

// 更新仙缘显示
function updateXianyuanDisplay() {
  document.getElementById('xianyuanDisplay').textContent = RealmBattleSystem.resources.xianyuan;
}

// 更新抽卡按钮状态
function updateDrawButton() {
  const drawBtn = document.getElementById('drawBtn');
  const hasEnoughXianyuan = RealmBattleSystem.resources.xianyuan >= 10;
  
  drawBtn.disabled = !hasEnoughXianyuan;
  if (!hasEnoughXianyuan) {
    drawBtn.style.opacity = '0.6';
    drawBtn.style.cursor = 'not-allowed';
  } else {
    drawBtn.style.opacity = '1';
    drawBtn.style.cursor = 'pointer';
  }
}

// 品级名称映射
const rankName = {
  red:'红色·顶级',
  orange:'橙色·圣人',
  gold:'黄色·高阶',
  blue:'蓝色·上仙',
  green:'绿色·地仙',
  white:'白色·小神'
};

function getRandomCard() {
  const r = Math.random() * 100;
  let color;
  
  // 调整后的概率分布
  if (r < 50) {
    color = 'white';           // 50%
  } else if (r < 80) {
    color = 'green';           // 30%
  } else if (r < 92) {
    color = 'blue';            // 12%
  } else if (r < 97) {
    color = 'gold';            // 5% (黄色)
  } else if (r < 99.4999) {
    color = 'orange';          // 2.4999%
  } else {
    color = 'red';             // 0.0001% (万分之一)
  }
  
  const list = pool.filter(c => getColor(c) === color);
  return list[Math.floor(Math.random() * list.length)];
}

function draw() {
  // 检查仙缘是否足够
  if (RealmBattleSystem.resources.xianyuan < 10) {
    alert('仙缘不足！');
    return;
  }
  
  // 消耗10仙缘
  RealmBattleSystem.resources.xianyuan -= 10;
  RealmBattleSystem.save();
  
  const card = getRandomCard();
  const color = getColor(card);
  
  // 更新 countMap
  G.countMap[card.name] = (G.countMap[card.name] || 0) + 1;
  
  // 更新 owned（去重）
  if(!G.owned.includes(card.name)) {
    G.owned.push(card.name);
  }
  
  // 更新最近抽卡记录
  G.lastDraw.push(card);
  
  // 保存所有数据
  saveSilent();
  
  // 显示本次抽卡结果
  const currentDiv = document.getElementById('currentCard');
  currentDiv.className = 'current-card ' + color;
  currentDiv.innerHTML = `
    <div>${card.name}</div>
    <div class="hp">HP ${card.hp}</div>
    <div class="rank">${rankName[color]}</div>
  `;
  
  // 更新仙缘显示和按钮状态
  updateXianyuanDisplay();
  updateDrawButton();
  
  // 显示消耗提示
  const costMsg = document.createElement('div');
  costMsg.style.cssText = 'margin-top:10px;color:#666;font-size:12px;';
  costMsg.textContent = '消耗10仙缘';
  currentDiv.appendChild(costMsg);
}
</script>