<!DOCTYPE html>
<meta charset="utf-8">
<title>战斗 - 神话抽卡</title>
<style>
  body{background:#fff;font-family:sans-serif;text-align:center;padding:20px}
  button{padding:8px 16px;margin:6px;cursor:pointer}
  
  /* 战场区域 */
  .battle-field{display:flex;justify-content:space-between;margin:20px 0;padding:20px;background:#f0f0f0;border-radius:10px;min-height:300px}
  .team{width:45%}
  .team-title{font-size:18px;font-weight:bold;margin-bottom:15px}
  .player-title{color:#2196f3}
  .enemy-title{color:#f44336}
  
  /* 卡牌样式 */
  .battle-card{width:80px;height:110px;border:3px solid #000;border-radius:6px;
               margin:8px;display:inline-flex;flex-direction:column;align-items:center;justify-content:center;
               font-weight:bold;font-size:14px;position:relative;transition:all 0.3s}
  .battle-card .hp{font-size:12px;margin-top:5px}
  .battle-card .realm{position:absolute;left:4px;top:4px;background:rgba(0,0,0,0.7);color:#fff;
                      font-size:10px;padding:2px 4px;border-radius:3px}
  
  /* 颜色样式 */
  .card-white{background:#eee;color:#000}
  .card-green{background:#2e7d32;color:#fff}
  .card-blue{background:#1565c0;color:#fff}
  .card-gold{background:#ffd900bd;color:#fff}
  .card-orange{background:#ef6c00;color:#fff}
  .card-red{background:#c62828;color:#fff}
  
  /* 状态样式 */
  .dead{opacity:0.3;border-color:#9e9e9e;background:#bdbdbd !important}
  .damage{animation:damageFlash 0.5s}
  
  @keyframes damageFlash {
    0% {background:#ffcccc}
    50% {background:#ff6666}
    100% {background:inherit}
  }
  
  /* 战斗日志 */
  .battle-log{height:150px;overflow-y:auto;padding:10px;background:#f5f5f5;border-radius:5px;
              margin:20px 0;text-align:left;font-size:12px;border:1px solid #e0e0e0}
  .log-entry{padding:3px 0;border-bottom:1px solid #eee}
  .log-player{color:#2196f3}
  .log-enemy{color:#f44336}
  .log-damage{color:#ff5722}
  .log-death{color:#9e9e9e}
  .log-reward{color:#4caf50}
  .log-system{color:#666}
  
  /* 资源显示 */
  .resources{display:flex;justify-content:center;gap:20px;margin:10px 0}
  .resource-item{padding:8px 15px;background:#fff3cd;border-radius:5px;font-size:16px}
  .resource-item .value{font-weight:bold;color:#e65100}
  
  /* 战斗状态 */
  .battle-status{margin:15px 0;padding:10px;background:#e8f5e9;border-radius:5px;font-size:14px;min-height:40px}
  
  /* 境界控制 */
  .realm-controls{display:flex;justify-content:center;gap:15px;margin:10px 0}
  .realm-btn{padding:6px 12px;background:#e3f2fd;border:1px solid #2196f3;border-radius:4px;cursor:pointer}
  .realm-btn:hover{background:#bbdefb}
  .realm-btn:disabled{background:#e0e0e0;color:#9e9e9e;border-color:#bdbdbd;cursor:not-allowed}
  
  /* 挂机状态 */
  .auto-battle-status{
    display:inline-block;
    padding:5px 10px;
    background:#c8e6c9;
    color:#2e7d32;
    border-radius:3px;
    font-size:12px;
    margin-left:10px;
    font-weight:bold;
  }
  
  /* 挂机控制 */
  .auto-controls{display:flex;justify-content:center;gap:10px;margin:10px 0}
  
  /* 按钮禁用状态 */
  button:disabled {
    background-color: #cccccc;
    color: #666666;
    cursor: not-allowed;
    border-color: #999999;
  }
</style>

<button onclick="location.href='index.html'">返回首页</button>
<button onclick="location.href='backpack.html'">返回背包</button>
<h2>战斗</h2>

<!-- 资源显示 -->
<div class="resources">
  <div class="resource-item">仙元: <span class="value" id="xianyuan">0</span></div>
  <div class="resource-item">灵丹: <span class="value" id="lingdan">0</span></div>
</div>

<!-- 境界控制 -->
<div class="realm-controls">
  <button class="realm-btn" onclick="changeRealm(-1)" id="prevRealmBtn">上一境界</button>
  <span id="currentRealmDisplay" style="font-weight:bold;padding:6px 12px">畜生道</span>
  <button class="realm-btn" onclick="changeRealm(1)" id="nextRealmBtn">下一境界</button>
</div>

<!-- 战斗状态 -->
<div class="battle-status" id="battleStatus">
  请先上阵卡牌
</div>

<!-- 挂机控制 -->
<div class="auto-controls">
  <button onclick="startBattle()" id="startBtn">开始战斗</button>
  <button onclick="toggleAutoBattle()" id="autoBtn">开启挂机</button>
  <button onclick="tryEscape()" id="escapeBtn" disabled>逃跑</button>
</div>

<!-- 战场 -->
<div class="battle-field">
  <!-- 玩家队伍 -->
  <div class="team">
    <div class="team-title player-title">我方队伍 <span id="autoStatus" style="display:none" class="auto-battle-status">挂机中</span></div>
    <div id="playerTeam"></div>
  </div>
  
  <!-- 敌人队伍 -->
  <div class="team">
    <div class="team-title enemy-title">妖精队伍</div>
    <div id="enemyTeam"></div>
  </div>
</div>

<!-- 战斗日志 -->
<div class="battle-log" id="battleLog"></div>

<script src="common.js"></script>
<script>
// 战斗状态
let battleState = {
  playerCards: [],
  enemyCards: [],
  battleActive: false,
  currentRound: 0,
  autoBattle: false,
  isAutoBattleRunning: false,
  isProcessingBattle: false,
  hasGivenReward: false
};

// 更新资源显示
function updateResources() {
  document.getElementById('xianyuan').textContent = RealmBattleSystem.resources.xianyuan;
  document.getElementById('lingdan').textContent = RealmBattleSystem.resources.lingdan;
}

// 更新境界信息
function updateRealmStatus() {
  const currentRealm = RealmBattleSystem.getCurrentRealmInfo();
  document.getElementById('currentRealmDisplay').textContent = currentRealm.name;
  
  // 更新境界按钮状态
  document.getElementById('prevRealmBtn').disabled = RealmBattleSystem.currentRealm === 0;
  document.getElementById('nextRealmBtn').disabled = RealmBattleSystem.currentRealm === RealmBattleSystem.realms.length - 1;
}

// 更新战斗状态显示
function updateBattleStatus() {
  const statusDiv = document.getElementById('battleStatus');
  
  if (!battleState.battleActive) {
    if (RealmBattleSystem.battleCards.length === 0) {
      statusDiv.textContent = '请先在背包中上阵卡牌';
    } else if (battleState.isAutoBattleRunning) {
      statusDiv.textContent = '挂机战斗中...';
    } else {
      statusDiv.textContent = '准备开始战斗';
    }
    return;
  }
  
  const playerAlive = battleState.playerCards.filter(c => c.currentHp > 0).length;
  const enemyAlive = battleState.enemyCards.filter(c => c.currentHp > 0).length;
  
  let statusText = `第${battleState.currentRound}回合 | 我方存活: ${playerAlive} | 敌方存活: ${enemyAlive}`;
  
  if (battleState.battleActive && playerAlive > 0 && enemyAlive > 0) {
    statusText += ' | 战斗中...';
  }
  
  statusDiv.textContent = statusText;
}

// 改变境界
function changeRealm(direction) {
  // 如果正在战斗中，不允许切换境界
  if (battleState.battleActive || battleState.isAutoBattleRunning) {
    addBattleLog('战斗中无法切换境界', 'system');
    return;
  }
  
  let result;
  if (direction > 0) {
    result = RealmBattleSystem.advanceRealm();
  } else {
    result = RealmBattleSystem.retreatRealm();
  }
  
  if (result.success) {
    updateRealmStatus();
    addBattleLog(`切换至: ${result.realm.name}`, 'system');
  }
}

// 生成妖精队伍
function generateEnemyTeam() {
  const currentRealm = RealmBattleSystem.getCurrentRealmInfo();
  const enemyCount = Math.min(6, Math.max(3, Math.floor(Math.random() * 4) + 3));
  const team = [];
  
  // 根据当前境界调整妖精强度
  const realmMultiplier = Math.pow(2, RealmBattleSystem.currentRealm);
  
  for (let i = 0; i < enemyCount; i++) {
    // 选择符合当前境界的怪物类型
    let filteredMonsters = monsters;
    
    if (RealmBattleSystem.currentRealm < 2) {
      filteredMonsters = monsters.slice(0, 12);
    } else if (RealmBattleSystem.currentRealm < 4) {
      filteredMonsters = monsters.slice(12, 22);
    } else if (RealmBattleSystem.currentRealm < 6) {
      filteredMonsters = monsters.slice(22, 28);
    } else {
      filteredMonsters = monsters.slice(28);
    }
    
    const monster = filteredMonsters[Math.floor(Math.random() * filteredMonsters.length)];
    
    let baseHp = Math.floor(monster.hp * realmMultiplier);
    const monsterBreakthroughLevel = Math.min(5, Math.floor(Math.random() * (RealmBattleSystem.currentRealm + 1)));
    const monsterHp = Math.floor(baseHp * Math.pow(2, monsterBreakthroughLevel));
    const finalHp = Math.min(monsterHp, currentRealm.maxMonsterHp);
    
    team.push({
      id: 'enemy_' + i,
      name: monster.name,
      baseHp: baseHp,
      currentHp: finalHp,
      maxHp: finalHp,
      breakthroughLevel: monsterBreakthroughLevel,
      color: getColor(monster),
      isAlive: true
    });
  }
  
  return team;
}

// 获取玩家上阵卡牌信息
function getPlayerBattleCards() {
  return RealmBattleSystem.battleCards.map((cardName, index) => {
    const card = pool.find(c => c.name === cardName);
    const breakthroughInfo = BreakthroughSystem.getBreakthroughInfo(cardName);
    const breakthroughDisplay = BreakthroughSystem.getBreakthroughDisplay(breakthroughInfo.level);
    const currentHp = Math.floor(card.hp * breakthroughDisplay.hpMultiplier);
    
    return {
      id: 'player_' + index,
      name: card.name,
      baseHp: card.hp,
      currentHp: currentHp,
      maxHp: currentHp,
      breakthroughLevel: breakthroughInfo.level,
      breakthroughStage: breakthroughDisplay.stage,
      breakthroughRealm: breakthroughDisplay.realm,
      color: getColor(card),
      isAlive: true
    };
  });
}

// 渲染队伍
function renderTeams() {
  renderPlayerTeam();
  renderEnemyTeam();
}

// 渲染玩家队伍
function renderPlayerTeam() {
  const container = document.getElementById('playerTeam');
  container.innerHTML = '';
  
  if (battleState.playerCards.length === 0) {
    container.innerHTML = '<p style="color:#666">请先在背包中上阵卡牌</p>';
    return;
  }
  
  battleState.playerCards.forEach(card => {
    const cardDiv = document.createElement('div');
    cardDiv.className = `battle-card card-${card.color} ${card.currentHp <= 0 ? 'dead' : ''}`;
    cardDiv.id = card.id;
    
    cardDiv.innerHTML = `
      ${card.breakthroughLevel > 0 ? `<div class="realm">${card.breakthroughRealm}</div>` : ''}
      <div>${card.name}</div>
      <div class="hp">HP ${card.currentHp.toLocaleString()}/${card.maxHp.toLocaleString()}</div>
    `;
    
    container.appendChild(cardDiv);
  });
}

// 渲染敌人队伍
function renderEnemyTeam() {
  const container = document.getElementById('enemyTeam');
  container.innerHTML = '';
  
  if (battleState.enemyCards.length === 0) {
    container.innerHTML = '<p style="color:#666">等待战斗开始</p>';
    return;
  }
  
  battleState.enemyCards.forEach(card => {
    const cardDiv = document.createElement('div');
    cardDiv.className = `battle-card card-${card.color} ${card.currentHp <= 0 ? 'dead' : ''}`;
    cardDiv.id = card.id;
    
    const realmDisplay = getRealmDisplay(card.breakthroughLevel);
    
    cardDiv.innerHTML = `
      ${card.breakthroughLevel > 0 ? `<div class="realm">${realmDisplay}</div>` : ''}
      <div>${card.name}</div>
      <div class="hp">HP ${card.currentHp.toLocaleString()}/${card.maxHp.toLocaleString()}</div>
    `;
    
    container.appendChild(cardDiv);
  });
}

// 获取境界显示
function getRealmDisplay(level) {
  if (level === 0) return '';
  const realms = ["凡", "炼", "筑", "金", "元", "化", "渡", "大", "散", "真", "玄", "金", "大罗", "准", "圣"];
  const realmIndex = Math.floor(level / 9);
  const levelInRealm = level % 9;
  return `${realms[realmIndex] || "凡"}${levelInRealm + 1}`;
}

// 开始战斗
function startBattle() {
  // 防止重复开始战斗
  if (battleState.battleActive || battleState.isProcessingBattle) {
    return;
  }
  
  // 检查是否有上阵卡牌
  if (RealmBattleSystem.battleCards.length === 0) {
    addBattleLog('请先在背包中上阵卡牌', 'system');
    return;
  }
  
  // 重置奖励标记
  battleState.hasGivenReward = false;
  
  // 初始化战斗状态
  battleState.isProcessingBattle = true;
  battleState.playerCards = getPlayerBattleCards();
  battleState.enemyCards = generateEnemyTeam();
  battleState.battleActive = true;
  battleState.currentRound = 1;
  
  // 更新界面
  updateBattleStatus();
  renderTeams();
  addBattleLog('战斗开始！', 'system');
  
  // 更新按钮状态
  updateButtonStates();
  
  // 开始战斗
  setTimeout(() => {
    executeRound();
  }, 500);
}

// 执行战斗回合
function executeRound() {
  if (!battleState.battleActive) {
    battleState.isProcessingBattle = false;
    return;
  }
  
  // 检查双方存活状态
  const alivePlayers = battleState.playerCards.filter(c => c.currentHp > 0);
  const aliveEnemies = battleState.enemyCards.filter(c => c.currentHp > 0);
  
  if (alivePlayers.length === 0 || aliveEnemies.length === 0) {
    endBattle();
    return;
  }
  
  // 玩家方攻击
  alivePlayers.forEach((attacker, index) => {
    if (aliveEnemies.length === 0) return;
    
    setTimeout(() => {
      const target = aliveEnemies[index % aliveEnemies.length] || aliveEnemies[0];
      performAttack(attacker, target, 'player');
      
      // 检查战斗是否结束
      setTimeout(() => {
        const stillAliveEnemies = battleState.enemyCards.filter(c => c.currentHp > 0);
        if (stillAliveEnemies.length === 0) {
          endBattle();
        }
      }, 300);
    }, index * 600); // 增加延迟时间，减缓速度
  });
  
  // 敌方攻击（延迟执行）
  setTimeout(() => {
    const stillAlivePlayers = battleState.playerCards.filter(c => c.currentHp > 0);
    const stillAliveEnemies = battleState.enemyCards.filter(c => c.currentHp > 0);
    
    if (stillAlivePlayers.length === 0 || stillAliveEnemies.length === 0) {
      endBattle();
      return;
    }
    
    stillAliveEnemies.forEach((attacker, index) => {
      if (stillAlivePlayers.length === 0) return;
      
      setTimeout(() => {
        const target = stillAlivePlayers[index % stillAlivePlayers.length] || stillAlivePlayers[0];
        performAttack(attacker, target, 'enemy');
        
        // 检查战斗是否结束
        setTimeout(() => {
          const stillAlivePlayersAfter = battleState.playerCards.filter(c => c.currentHp > 0);
          if (stillAlivePlayersAfter.length === 0) {
            endBattle();
          }
        }, 300);
      }, index * 600); // 增加延迟时间，减缓速度
    });
    
    // 准备下一回合
    setTimeout(() => {
      if (battleState.battleActive) {
        battleState.currentRound++;
        updateBattleStatus();
        
        const stillAlivePlayers = battleState.playerCards.filter(c => c.currentHp > 0);
        const stillAliveEnemies = battleState.enemyCards.filter(c => c.currentHp > 0);
        
        if (stillAlivePlayers.length > 0 && stillAliveEnemies.length > 0) {
          setTimeout(executeRound, 1000); // 增加回合间隔
        } else {
          endBattle();
        }
      }
    }, stillAliveEnemies.length * 600 + 500);
  }, alivePlayers.length * 600 + 500);
}

// 执行攻击
function performAttack(attacker, target, side) {
  if (!attacker || !target || attacker.currentHp <= 0 || target.currentHp <= 0) return;
  
  // 计算伤害（双方HP对比，取较小值）
  const damage = Math.min(attacker.currentHp, target.currentHp);
  
  // 应用伤害
  attacker.currentHp -= damage;
  target.currentHp -= damage;
  
  // 添加战斗日志
  const sideText = side === 'player' ? '我方' : '敌方';
  addBattleLog(`${sideText} ${attacker.name} 攻击 ${target.name}，双方受到 ${damage} 点伤害`, side === 'player' ? 'player' : 'enemy');
  
  // 检查是否死亡
  if (attacker.currentHp <= 0) {
    attacker.currentHp = 0;
    addBattleLog(`${sideText} ${attacker.name} 阵亡！`, 'death');
  }
  
  if (target.currentHp <= 0) {
    target.currentHp = 0;
    const targetSideText = side === 'player' ? '敌方' : '我方';
    addBattleLog(`${targetSideText} ${target.name} 被击败！`, 'death');
  }
  
  // 更新界面
  renderTeams();
  
  // 显示伤害效果
  showDamageEffect(attacker.id);
  showDamageEffect(target.id);
}

// 显示伤害效果
function showDamageEffect(cardId) {
  const card = document.getElementById(cardId);
  if (card) {
    card.classList.add('damage');
    setTimeout(() => {
      card.classList.remove('damage');
    }, 300);
  }
}

// 结束战斗
function endBattle() {
  battleState.battleActive = false;
  battleState.isProcessingBattle = false;
  
  const playerAlive = battleState.playerCards.filter(c => c.currentHp > 0).length;
  const enemyAlive = battleState.enemyCards.filter(c => c.currentHp > 0).length;
  
  if (playerAlive === 0) {
    // 玩家失败 - 直接重置
    addBattleLog('战斗失败！所有卡牌阵亡，数据已重置！', 'system');
    
    // 重置所有数据
    reset();
    BreakthroughSystem.resetAll();
    RealmBattleSystem.resetAll();
    
    // 重新加载页面
    setTimeout(() => {
      location.href = 'index.html';
    }, 2000);
    
  } else if (enemyAlive === 0) {
    // 玩家胜利 - 检查是否已经给过奖励
    if (!battleState.hasGivenReward) {
      battleState.hasGivenReward = true; // 标记奖励已给
      
      const currentRealm = RealmBattleSystem.getCurrentRealmInfo();
      const rewardXianyuan = currentRealm.reward.xianyuan;
      const rewardLingdan = currentRealm.reward.lingdan;
      
      // 添加奖励
      RealmBattleSystem.addResources(rewardXianyuan, rewardLingdan);
      updateResources();
      
      addBattleLog(`战斗胜利！获得 ${rewardXianyuan} 仙元和 ${rewardLingdan} 灵丹！`, 'reward');
      
      // 添加战斗记录
      RealmBattleSystem.addBattleHistory('胜利');
    }
  }
  
  // 更新按钮状态
  updateButtonStates();
  updateBattleStatus();
  
  // 如果开启挂机，自动开始下一场战斗
  if (battleState.autoBattle && battleState.isAutoBattleRunning) {
    // 增加延迟时间
    setTimeout(() => {
      if (battleState.isAutoBattleRunning && battleState.autoBattle) {
        startBattle();
      }
    }, 3000);
  }
}

// 更新按钮状态
function updateButtonStates() {
  const hasBattleCards = RealmBattleSystem.battleCards.length > 0;
  const isBattleActive = battleState.battleActive;
  
  const startBtn = document.getElementById('startBtn');
  const autoBtn = document.getElementById('autoBtn');
  const escapeBtn = document.getElementById('escapeBtn');
  const autoStatus = document.getElementById('autoStatus');
  
  // 基础状态
  startBtn.disabled = !hasBattleCards || isBattleActive;
  escapeBtn.disabled = !isBattleActive;
  autoBtn.disabled = !hasBattleCards;
  
  // 挂机状态
  if (battleState.autoBattle) {
    autoStatus.style.display = 'inline-block';
    autoBtn.textContent = '停止挂机';
  } else {
    autoStatus.style.display = 'none';
    autoBtn.textContent = '开启挂机';
  }
}

// 切换挂机模式
function toggleAutoBattle() {
  if (RealmBattleSystem.battleCards.length === 0) {
    addBattleLog('请先在背包中上阵卡牌', 'system');
    return;
  }
  
  battleState.autoBattle = !battleState.autoBattle;
  
  if (battleState.autoBattle) {
    // 开启挂机
    battleState.isAutoBattleRunning = true;
    addBattleLog('挂机模式已开启', 'system');
    
    // 如果当前没有战斗，立即开始
    if (!battleState.battleActive && !battleState.isProcessingBattle) {
      startBattle();
    }
  } else {
    // 关闭挂机
    battleState.isAutoBattleRunning = false;
    addBattleLog('挂机模式已关闭', 'system');
  }
  
  updateButtonStates();
}

// 尝试逃跑
function tryEscape() {
  if (!battleState.battleActive || battleState.isProcessingBattle) return;
  
  const result = RealmBattleSystem.tryEscape();
  
  if (result.success) {
    addBattleLog('成功逃脱', 'system');
    
    // 停止当前战斗
    battleState.battleActive = false;
    battleState.isAutoBattleRunning = false;
    battleState.autoBattle = false;
    battleState.isProcessingBattle = false;
    
    // 更新显示
    updateButtonStates();
    
    updateBattleStatus();
    updateResources();
  } else {
    addBattleLog('逃跑失败！所有数据已重置！', 'system');
    setTimeout(() => {
      location.href = 'index.html';
    }, 2000);
  }
}

// 添加战斗日志
function addBattleLog(message, type = 'system') {
  const logDiv = document.getElementById('battleLog');
  const entry = document.createElement('div');
  entry.className = `log-entry log-${type}`;
  
  const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  entry.textContent = `[${time}] ${message}`;
  
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  // 保持最多50条日志
  if (logDiv.children.length > 50) {
    logDiv.removeChild(logDiv.firstChild);
  }
}

// 页面加载
window.onload = function() {
  if (localStorage.getItem("myth_save")) {
    loadSilent();
  }
  BreakthroughSystem.init();
  RealmBattleSystem.init();
  updateResources();
  updateRealmStatus();
  updateBattleStatus();
  updateButtonStates(); // 初始化按钮状态
};
</script>