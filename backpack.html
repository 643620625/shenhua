<!DOCTYPE html>
<meta charset="utf-8">
<title>背包 - 神话抽卡</title>
<style>
  body{background:#fff;font-family:sans-serif;text-align:center;padding:20px}
  button{padding:8px 16px;margin:6px}
  
  /* 卡片网格样式 - 缩小版 */
  .card-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:15px}
  .card{position:relative;width:70px;height:95px;border:2px solid #000;border-radius:4px;
        display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:bold;font-size:12px}
  .card .hp{font-size:10px;margin-top:3px;color:#333}
  .card .count{position:absolute;right:2px;bottom:2px;background:#e53935;color:#fff;font-size:10px;
               padding:1px 3px;border-radius:6px}
  .card .realm{position:absolute;left:2px;top:2px;background:rgba(0,0,0,0.7);color:#fff;font-size:9px;
               padding:1px 3px;border-radius:3px}
  
  /* 颜色样式 */
  .white{background:#eee;color:#000}
  .green{background:#2e7d32;color:#fff}
  .blue{background:#1565c0;color:#fff}
  .gold{background:#ffd900bd;color:#fff}
  .orange{background:#ef6c00;color:#fff}
  .red{background:#c62828;color:#fff}
  
  /* 排序选项 */
  .sort-options{margin:10px auto;padding:10px;background:#f5f5f5;border-radius:5px;max-width:500px}
  .sort-btn{padding:5px 10px;margin:0 5px;background:#e0e0e0;border:none;border-radius:3px;cursor:pointer;font-size:12px}
  .sort-btn.active{background:#4caf50;color:white}
  
  /* 上阵卡牌区域 */
  .battle-section{margin:15px auto;padding:15px;background:#e8f5e9;border-radius:8px;max-width:600px}
  .battle-cards{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin:10px 0}
  .battle-card{width:60px;height:80px;border:2px solid #4caf50;border-radius:4px;background:#fff;
               display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;
               position:relative}
  .battle-card .battle-realm{position:absolute;left:2px;top:2px;background:rgba(76, 175, 80, 0.9);color:#fff;font-size:8px;
                            padding:1px 2px;border-radius:2px}
  .battle-card .battle-name{font-weight:bold;font-size:9px}
  .battle-card .battle-hp{font-size:8px;color:#666;margin-top:2px}
  
  .empty-slot{width:60px;height:80px;border:2px dashed #ccc;border-radius:4px;background:#f5f5f5;
              display:flex;align-items:center;justify-content:center;color:#999;font-size:11px}
  
  /* 资源显示 */
  .resources{display:flex;justify-content:center;gap:15px;margin:10px 0}
  .resource-item{padding:5px 10px;background:#fff3cd;border-radius:4px;font-size:14px}
  .resource-item .value{font-weight:bold;color:#e65100}
  
  /* 境界显示 */
  .realm-info{margin:10px auto;padding:10px;background:#e3f2fd;border-radius:5px;max-width:500px;font-size:14px}
  
  .empty-msg{color:#666;margin:40px 0;font-size:16px}
</style>

<button onclick="location.href='index.html'">返回首页</button>
<button onclick="location.href='battle.html'">去战斗</button>
<button onclick="location.href='breakthrough.html'">去突破</button>
<button onclick="refreshBackpack()">刷新背包</button>
<h2>背包</h2>

<!-- 资源显示 -->
<div class="resources">
  <div class="resource-item">仙元: <span class="value" id="xianyuan">0</span></div>
  <div class="resource-item">灵丹: <span class="value" id="lingdan">0</span></div>
</div>

<!-- 境界显示 -->
<div class="realm-info">
  当前境界: <span id="currentRealm" style="font-weight:bold">畜生道</span>
</div>

<!-- 上阵卡牌区域 -->
<div class="battle-section">
  <h3>上阵卡牌 (最多6张)</h3>
  <div class="battle-cards" id="battleCards">
    <!-- 动态生成 -->
  </div>
  <div style="margin-top:10px;color:#666;font-size:14px">
    点击下方卡牌可上阵/下阵
  </div>
</div>

<div class="sort-options">
  排序方式:
  <button class="sort-btn active" onclick="changeSort('hp')">按HP</button>
  <button class="sort-btn" onclick="changeSort('color')">按颜色</button>
  <button class="sort-btn" onclick="changeSort('breakthrough')">按境界</button>
  <button class="sort-btn" onclick="changeSort('name')">按名称</button>
</div>

<div id="backpack"></div>

<script src="common.js"></script>
<script>
// 当前排序方式
let currentSort = 'hp';
const colorOrder = ['red','orange','gold','blue','green','white'];

// 刷新所有数据
function refreshBackpack() {
  if (localStorage.getItem("myth_save")) {
    loadSilent();
  }
  BreakthroughSystem.init();
  RealmBattleSystem.init();
  updateResources();
  updateRealmInfo();
  renderBattleCards();
  renderBackpack();
}

// 更新资源显示
function updateResources() {
  document.getElementById('xianyuan').textContent = RealmBattleSystem.resources.xianyuan;
  document.getElementById('lingdan').textContent = RealmBattleSystem.resources.lingdan;
}

// 更新境界显示
function updateRealmInfo() {
  const currentRealm = RealmBattleSystem.getCurrentRealmInfo();
  document.getElementById('currentRealm').textContent = currentRealm.name;
}

// 渲染上阵卡牌
function renderBattleCards() {
  const container = document.getElementById('battleCards');
  container.innerHTML = '';
  
  // 显示已上阵卡牌
  RealmBattleSystem.battleCards.forEach(cardName => {
    const card = pool.find(c => c.name === cardName);
    if (card) {
      const breakthroughInfo = BreakthroughSystem.getBreakthroughInfo(cardName);
      const breakthroughDisplay = BreakthroughSystem.getBreakthroughDisplay(breakthroughInfo.level);
      const currentHp = Math.floor(card.hp * breakthroughDisplay.hpMultiplier);
      
      const cardDiv = document.createElement('div');
      cardDiv.className = 'battle-card';
      cardDiv.innerHTML = `
        ${breakthroughInfo.level > 0 ? `<div class="battle-realm">${formatRealmDisplay(breakthroughDisplay.stage)}</div>` : ''}
        <div class="battle-name">${card.name}</div>
        <div class="battle-hp">${currentHp.toLocaleString()}</div>
      `;
      container.appendChild(cardDiv);
    }
  });
  
  // 显示空位
  const emptySlots = 6 - RealmBattleSystem.battleCards.length;
  for (let i = 0; i < emptySlots; i++) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'empty-slot';
    emptyDiv.textContent = '空位';
    container.appendChild(emptyDiv);
  }
}

// 格式化境界显示：凡人·二重
function formatRealmDisplay(stage) {
  // 将"凡人二重"转换为"凡人·二重"
  return stage.replace(/([^\d]+)(\d+重)/, '$1·$2');
}

// 切换排序方式
function changeSort(sortType) {
  currentSort = sortType;
  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  renderBackpack();
}

// 获取卡牌完整信息
function getCardFullInfo(cardName, baseHp, color) {
  const breakthroughInfo = BreakthroughSystem.getBreakthroughInfo(cardName);
  const breakthroughDisplay = BreakthroughSystem.getBreakthroughDisplay(breakthroughInfo.level);
  const currentHp = Math.floor(baseHp * breakthroughDisplay.hpMultiplier);
  const count = G.countMap[cardName] || 0;
  const isInBattle = RealmBattleSystem.battleCards.includes(cardName);
  
  return {
    name: cardName,
    baseHp: baseHp,
    color: color,
    count: count,
    breakthroughLevel: breakthroughInfo.level,
    breakthroughStage: breakthroughDisplay.stage,
    breakthroughRealm: breakthroughDisplay.realm,
    currentHp: currentHp,
    isInBattle: isInBattle
  };
}

// 上阵/下阵卡牌
function toggleBattleCard(cardName) {
  if (RealmBattleSystem.battleCards.includes(cardName)) {
    RealmBattleSystem.removeBattleCard(cardName);
    renderBattleCards();
    renderBackpack();
  } else {
    const result = RealmBattleSystem.addBattleCard(cardName);
    if (result.success) {
      renderBattleCards();
      renderBackpack();
    } else {
      alert(result.message);
    }
  }
}

function renderBackpack() {
  if (!G.countMap) G.countMap = {};
  
  const box = document.getElementById('backpack');
  box.innerHTML = '';
  
  // 收集所有卡片信息
  let allCards = [];
  for(let name in G.countMap) {
    const count = G.countMap[name];
    if (count > 0) {
      const card = pool.find(c => c.name === name);
      if (card) {
        const cardInfo = getCardFullInfo(name, card.hp, getColor(card));
        allCards.push(cardInfo);
      }
    }
  }
  
  if (allCards.length === 0) {
    box.innerHTML = '<p class="empty-msg">背包空空如也，快去抽卡吧！</p>';
    return;
  }
  
  // 排序
  allCards.sort((a, b) => {
    switch(currentSort) {
      case 'hp':
        if (b.currentHp !== a.currentHp) return b.currentHp - a.currentHp;
        if (b.breakthroughLevel !== a.breakthroughLevel) return b.breakthroughLevel - a.breakthroughLevel;
        return a.name.localeCompare(b.name);
        
      case 'color':
        const orderA = colorOrder.indexOf(a.color);
        const orderB = colorOrder.indexOf(b.color);
        if (orderA !== orderB) return orderA - orderB;
        if (b.currentHp !== a.currentHp) return b.currentHp - a.currentHp;
        return a.name.localeCompare(b.name);
        
      case 'breakthrough':
        if (b.breakthroughLevel !== a.breakthroughLevel) return b.breakthroughLevel - a.breakthroughLevel;
        if (b.currentHp !== a.currentHp) return b.currentHp - a.currentHp;
        return a.name.localeCompare(b.name);
        
      case 'name':
        return a.name.localeCompare(b.name);
        
      default:
        return a.name.localeCompare(b.name);
    }
  });
  
  // 创建卡片网格
  const grid = document.createElement('div');
  grid.className = 'card-grid';
  
  allCards.forEach(card => {
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card ' + card.color;
    if (card.isInBattle) {
      cardDiv.style.borderColor = '#4caf50';
      cardDiv.style.boxShadow = '0 0 5px #4caf50';
    }
    
    // 显示名称、HP，境界在左上角
    cardDiv.innerHTML = `
      ${card.breakthroughLevel > 0 ? `<div class="realm">${formatRealmDisplay(card.breakthroughStage)}</div>` : ''}
      <div>${card.name}</div>
      <div class="hp">HP ${card.currentHp.toLocaleString()}</div>
      <span class="count">×${card.count}</span>
    `;
    
    // 点击上阵/下阵
    cardDiv.onclick = () => toggleBattleCard(card.name);
    
    grid.appendChild(cardDiv);
  });
  
  box.appendChild(grid);
}

// 页面加载
window.onload = function() {
  if (localStorage.getItem("myth_save")) {
    loadSilent();
  }
  BreakthroughSystem.init();
  RealmBattleSystem.init();
  updateResources();
  updateRealmInfo();
  renderBattleCards();
  renderBackpack();
  
  window.addEventListener('focus', refreshBackpack);
};
</script>